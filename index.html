<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>üê∞ Bunny Home</title>
<style>
:root{
  --coral:#FF8C70;--coral-dk:#E05030;--green:#4CAF7C;
  --text:#3A2E2A;--hole:#1A1210;
  --sh:0 4px 20px rgba(58,46,42,.13);--sh-sm:0 2px 8px rgba(58,46,42,.10);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;touch-action:manipulation;}
html,body{width:100%;height:100%;overflow:hidden;background:#1A1210;}
body{font-family:system-ui,sans-serif;color:var(--text);display:flex;justify-content:center;align-items:center;}
#app{width:100%;max-width:430px;height:100dvh;display:flex;flex-direction:column;overflow:hidden;background:#FFF8F0;}
.screen{display:none;flex-direction:column;flex:1;min-height:0;overflow:hidden;}
.screen.active{display:flex;}

/* HOME */
#home{background:linear-gradient(180deg,#D4EDAA 0%,#E8F5C8 30%,#FFF8EE 100%);}
.home-hdr{padding:16px 20px 10px;flex-shrink:0;display:flex;justify-content:space-between;align-items:center;}
.home-title{font-size:26px;font-weight:900;}
.home-title span{color:var(--coral);}
.home-sub{font-size:11px;color:#7A8A5A;font-weight:600;margin-top:1px;}
.chip{background:#fff;border-radius:10px;padding:4px 10px;font-size:12px;font-weight:700;box-shadow:var(--sh-sm);display:flex;align-items:center;gap:3px;}

/* Map road */
.map-scroll{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;}
.map-canvas{position:relative;width:100%;}
.lv-node{position:absolute;width:58px;height:58px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;transform:translate(-50%,-50%);cursor:pointer;box-shadow:0 5px 0 rgba(0,0,0,.18),0 2px 8px rgba(0,0,0,.12);border:3.5px solid transparent;z-index:2;user-select:none;transition:transform .1s;}
.lv-node:active{transform:translate(-50%,-50%) scale(.88);}
.lv-node.done{background:#4CAF7C;border-color:#2E8A5A;color:#fff;}
.lv-node.current{background:var(--coral);border-color:var(--coral-dk);color:#fff;animation:nodePulse 1.4s ease-in-out infinite;}
.lv-node.locked{background:#C8BEB8;border-color:#A89890;color:#786860;cursor:default;}
.lv-node.locked:active{transform:translate(-50%,-50%);}
@keyframes nodePulse{0%,100%{box-shadow:0 5px 0 rgba(180,50,20,.4),0 0 0 0 rgba(255,140,112,.6);}50%{box-shadow:0 5px 0 rgba(180,50,20,.4),0 0 0 11px rgba(255,140,112,0);}}
.lv-num{font-size:14px;font-weight:900;line-height:1;}
.lv-ico{font-size:20px;line-height:1;}
.lv-stars{font-size:8px;line-height:1;margin-top:2px;letter-spacing:1px;}
.bunny-walker{position:absolute;font-size:26px;transform:translate(-50%,-50%);z-index:10;pointer-events:none;}

/* GAME */
#game{background:linear-gradient(170deg,#F2FCF5,#EDF6FF);}
.hud{display:flex;justify-content:space-between;align-items:center;padding:10px 12px 4px;flex-shrink:0;}
.hud-l,.hud-r{display:flex;gap:5px;align-items:center;}
.chip-warn{animation:warnPulse .5s ease-in-out infinite alternate;}
@keyframes warnPulse{from{background:#fff;}to{background:#FFE0D8;}}
.btn-sm{background:#fff;border:none;border-radius:10px;padding:5px 10px;font-size:12px;font-weight:700;color:#9A8880;cursor:pointer;box-shadow:var(--sh-sm);}

.board-area{flex:1;min-height:0;display:flex;justify-content:center;align-items:center;padding:4px 8px;}
.board{display:grid;gap:1px;background:rgba(100,160,200,.38);border-radius:14px;overflow:hidden;border:2.5px solid rgba(100,160,200,.3);box-shadow:var(--sh);}
.cell{display:flex;align-items:center;justify-content:center;background:#F2FFF6;}
.cell.c-hole{background:var(--hole)!important;}
.cell.c-bunny{background:#FFF0E8;}
.cell.c-carrot{background:#FFFBEF;}
.cell.c-house{background:#EBF4FF;}
.cell.c-house-glow{background:#CCE8FF;animation:hGlow .9s ease-in-out infinite alternate;}
.cell.trail{background:#DFF8E8!important;}
.cell.trail.c-hole{background:var(--hole)!important;}
@keyframes hGlow{from{background:#CCE8FF;}to{background:#99CCFF;}}
.cell-em{display:block;line-height:1;user-select:none;pointer-events:none;}
.cell-em.hop{animation:hopA .28s ease-out forwards;}
@keyframes hopA{0%{transform:scale(1) translateY(0);}35%{transform:scale(1.6) translateY(-5px);}70%{transform:scale(.9) translateY(2px);}100%{transform:scale(1);}}
.board.shake{animation:bShake .4s ease-in-out;}
@keyframes bShake{0%,100%{transform:translateX(0);}20%{transform:translateX(-7px);}40%{transform:translateX(7px);}60%{transform:translateX(-4px);}80%{transform:translateX(4px);}}

.planner{flex-shrink:0;display:flex;flex-direction:column;gap:5px;padding:5px 10px 14px;background:rgba(255,255,255,.82);backdrop-filter:blur(8px);border-top:1.5px solid rgba(180,200,220,.3);}
.palette-row{display:flex;gap:5px;overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:2px;scrollbar-width:none;}
.palette-row::-webkit-scrollbar{display:none;}
.tok{width:44px;height:44px;border-radius:11px;display:flex;align-items:center;justify-content:center;cursor:grab;border:2px solid;box-shadow:var(--sh-sm);flex-shrink:0;user-select:none;-webkit-user-select:none;transition:transform .1s,opacity .15s;}
.tok.disabled{opacity:.3;pointer-events:none;}
.tok.tm{background:#EDF6FF;border-color:#A0C4FF;}
.tok.tj{background:#FFF4EF;border-color:#FFAA88;}
.tok .ti{font-size:20px;line-height:1;pointer-events:none;}

#dragGhost{position:fixed;pointer-events:none;z-index:9999;transform:translate(-50%,-50%) scale(1.15);width:44px;height:44px;border-radius:11px;display:none;align-items:center;justify-content:center;font-size:22px;box-shadow:0 8px 24px rgba(0,0,0,.25);}

.seq-hdr{display:flex;justify-content:space-between;align-items:center;}
.seq-label{font-size:10px;font-weight:800;letter-spacing:.8px;text-transform:uppercase;color:#9A8880;}
.seq-count{font-size:11px;font-weight:900;color:var(--coral);}
.queue-wrap{display:flex;align-items:center;gap:4px;min-height:48px;background:#F5F0FF;border:2px dashed #CCBBEE;border-radius:12px;padding:5px 8px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;transition:background .15s,border-color .15s;}
.queue-wrap::-webkit-scrollbar{display:none;}
.queue-wrap.drag-over{background:#EDE5FF;border-color:#9977DD;border-style:solid;}
.q-hint{font-size:10px;color:#C0B0D8;font-weight:700;text-transform:uppercase;letter-spacing:.5px;white-space:nowrap;pointer-events:none;}
.qt{width:38px;height:38px;border-radius:9px;background:#fff;border:2px solid #CCBBEE;display:flex;align-items:center;justify-content:center;font-size:15px;cursor:pointer;flex-shrink:0;box-shadow:0 1px 4px rgba(0,0,0,.07);transition:transform .1s,background .12s,border-color .12s;user-select:none;}
.qt.qj{border-color:#FFAA88;background:#FFF4EF;}
.qt.active-step{background:#FF8C70!important;border-color:#E05030!important;transform:scale(1.22);box-shadow:0 0 0 4px rgba(255,80,48,.28);z-index:2;}
.qt.done-step{background:#D8F4E8!important;border-color:#88CCAA!important;opacity:.6;}
.run-row{display:flex;gap:7px;}
.btn-run{flex:1;background:linear-gradient(135deg,#FF8C70,#E04820);color:#fff;border:none;border-radius:12px;padding:11px;font-size:17px;font-weight:900;cursor:pointer;box-shadow:0 4px 14px rgba(220,72,32,.32);}
.btn-run:active{transform:scale(.97);}
.btn-run:disabled{background:linear-gradient(135deg,#C8C0BC,#B0A8A4);box-shadow:none;cursor:default;}
.btn-clear{background:#fff;color:#9A8880;border:2px solid #E0D8D4;border-radius:12px;padding:11px 14px;font-size:14px;font-weight:700;cursor:pointer;}

.overlay{position:absolute;inset:0;background:rgba(20,12,10,.58);display:flex;align-items:center;justify-content:center;z-index:200;backdrop-filter:blur(6px);}
.modal{background:#fff;border-radius:26px;padding:26px 22px;text-align:center;max-width:288px;width:88%;box-shadow:0 20px 60px rgba(0,0,0,.28);position:relative;overflow:hidden;}
.mico{font-size:58px;display:block;margin-bottom:8px;animation:mpop .45s cubic-bezier(.34,1.56,.64,1);}
@keyframes mpop{0%{transform:scale(0);}100%{transform:scale(1);}}
.mtitle{font-size:22px;font-weight:900;margin-bottom:4px;}
.mstars{font-size:30px;margin-bottom:8px;letter-spacing:4px;}
.msub{font-size:12px;color:#7A6A62;margin-bottom:14px;line-height:1.55;}
.mbtn{display:block;width:100%;border:none;border-radius:50px;padding:12px;font-size:16px;font-weight:900;cursor:pointer;margin-bottom:8px;}
.mbtn:active{transform:scale(.97);}
.mbtn.coral{background:linear-gradient(135deg,#FF8C70,#E04820);color:#fff;box-shadow:0 4px 14px rgba(220,72,32,.32);}
.mbtn.grn{background:linear-gradient(135deg,#4CAF7C,#2E8A5A);color:#fff;}
.mbtn.ghost{background:#fff;color:#9A8880;border:2px solid #E0D8D4;}
.cfw{position:absolute;inset:0;pointer-events:none;overflow:hidden;z-index:0;}
.cfp{position:absolute;top:-12px;animation:cff linear forwards;}
@keyframes cff{to{transform:translateY(115vh) rotate(720deg);opacity:0;}}
</style>
</head>
<body>
<div id="app">

  <div id="home" class="screen active">
    <div class="home-hdr">
      <div>
        <div class="home-title">Bunny <span>Home</span> üê∞</div>
        <div class="home-sub">collect carrots ¬∑ find your way home</div>
      </div>
      <div class="chip">‚≠ê <span id="homeProg">0/30</span></div>
    </div>
    <div class="map-scroll" id="mapScroll"><div class="map-canvas" id="mapCanvas"></div></div>
  </div>

  <div id="game" class="screen">
    <div class="hud">
      <div class="hud-l">
        <div class="chip">üéØ <span id="hLv">Lv1</span></div>
        <div class="chip">ü•ï <span id="hCr">0</span></div>
        <div class="chip" id="hStChip">üë£ <span id="hSt">0</span></div>
      </div>
      <div class="hud-r">
        <button class="btn-sm" onclick="showHome()">üó∫Ô∏è Map</button>
      </div>
    </div>
    <div class="board-area" id="boardArea">
      <div class="board" id="board"></div>
    </div>
    <div class="planner">
      <div class="palette-row" id="palette"></div>
      <div class="seq-hdr">
        <span class="seq-label">Sequence</span>
        <span class="seq-count"><span id="seqUsed">0</span>/<span id="seqMax">0</span> steps</span>
      </div>
      <div class="queue-wrap" id="qWrap">
        <span class="q-hint" id="qHint">tap or drag moves here ‚Üë</span>
      </div>
      <div class="run-row">
        <button class="btn-clear" onclick="clearQ()">‚úï Clear</button>
        <button class="btn-run" id="btnRun" disabled onclick="runSteps()">‚ñ∂ Run!</button>
      </div>
    </div>

    <div class="overlay" id="winMod" style="display:none">
      <div class="modal">
        <div class="cfw" id="cfWrap"></div>
        <span class="mico">üéâ</span>
        <div class="mtitle">Level Complete!</div>
        <div class="mstars">‚≠ê‚≠ê‚≠ê</div>
        <div class="msub" id="mSub">Amazing!</div>
        <button class="mbtn grn" onclick="nextLevel()">Next Level ‚Üí</button>
        <button class="mbtn ghost" onclick="showHome()">World Map üó∫Ô∏è</button>
      </div>
    </div>
    <div class="overlay" id="failMod" style="display:none">
      <div class="modal">
        <span class="mico" id="fIco">üò¨</span>
        <div class="mtitle" id="fTitle">Oops!</div>
        <div class="msub" id="fSub">Try again!</div>
        <button class="mbtn coral" onclick="retryLevel()">Try Again üê∞</button>
        <button class="mbtn ghost" onclick="showHome()">World Map üó∫Ô∏è</button>
      </div>
    </div>
  </div>

</div>
<div id="dragGhost"></div>

<script>
// ‚îÄ‚îÄ RNG ‚îÄ‚îÄ
function mkRng(seed) {
  var s = seed >>> 0;
  return function() {
    s = (s ^ 61) ^ (s >>> 16);
    s += s << 3;
    s ^= s >>> 4;
    s *= 0x27d4eb2d;
    s ^= s >>> 15;
    return (s >>> 0) / 4294967296;
  };
}

// ‚îÄ‚îÄ Level config ‚îÄ‚îÄ
function boardSize(li) { return li < 2 ? 3 : li < 5 ? 5 : 8; }
function carrotCount(li) { return li < 2 ? 1 : li < 5 ? 2 : Math.min(2 + Math.floor(li / 4), 6); }
function holeCount(li) { return li < 2 ? 0 : li < 5 ? Math.floor(li / 3) : Math.min(1 + Math.floor((li - 5) / 4), 5); }
function stepBuffer(li, opt) {
  var f = li < 5 ? 0.9 : li < 15 ? 0.55 : li < 25 ? 0.35 : 0.25;
  return Math.max(3, Math.round(opt * f));
}

// ‚îÄ‚îÄ Board generation ‚îÄ‚îÄ
function genBoard(li, seedOff) {
  var sz = boardSize(li);
  var rng = mkRng((li + 1) * 997 + seedOff * 7919);
  var all = [];
  for (var r = 0; r < sz; r++) {
    for (var c = 0; c < sz; c++) {
      all.push([r, c]);
    }
  }
  // shuffle
  for (var i = all.length - 1; i > 0; i--) {
    var j = Math.floor(rng() * (i + 1));
    var tmp = all[i]; all[i] = all[j]; all[j] = tmp;
  }
  var used = {};
  var pi = 0;
  function take() {
    while (used[all[pi][0] * 100 + all[pi][1]]) pi++;
    var p = all[pi];
    used[p[0] * 100 + p[1]] = true;
    pi++;
    return p;
  }
  var b = take(), ho = take();
  var ca = [], hl = [];
  for (var x = 0; x < carrotCount(li); x++) ca.push(take());
  for (var x = 0; x < holeCount(li); x++) hl.push(take());
  return { sz: sz, b: b, ho: ho, ca: ca, hl: hl };
}

// ‚îÄ‚îÄ BFS ‚îÄ‚îÄ
var DIRS = [[-1,0],[1,0],[0,-1],[0,1],[-1,1],[-1,-1],[1,1],[1,-1]];

function bfs(lvData) {
  var sz = lvData.sz, b = lvData.b, ho = lvData.ho, ca = lvData.ca, hl = lvData.hl;
  var hSet = {};
  for (var i = 0; i < hl.length; i++) hSet[hl[i][0] * 100 + hl[i][1]] = true;
  var caMap = {};
  for (var i = 0; i < ca.length; i++) caMap[ca[i][0] * 100 + ca[i][1]] = i;
  var fullMask = (1 << ca.length) - 1;
  var startKey = b[0] + ',' + b[1] + ',' + fullMask;
  var visited = {};
  visited[startKey] = 0;
  var q = [[b[0], b[1], fullMask, 0]];
  var head = 0;
  while (head < q.length) {
    var cur = q[head++];
    var r = cur[0], c = cur[1], mask = cur[2], d = cur[3];
    if (mask === 0 && r === ho[0] && c === ho[1]) return d;
    for (var di = 0; di < DIRS.length; di++) {
      var nr = r + DIRS[di][0], nc = c + DIRS[di][1];
      if (nr < 0 || nr >= sz || nc < 0 || nc >= sz) continue;
      if (hSet[nr * 100 + nc]) continue;
      var nm = mask;
      var ci = caMap[nr * 100 + nc];
      if (ci !== undefined) nm = mask & ~(1 << ci);
      var nk = nr + ',' + nc + ',' + nm;
      if (!visited[nk]) {
        visited[nk] = d + 1;
        q.push([nr, nc, nm, d + 1]);
      }
    }
  }
  return null;
}

function buildLevel(li) {
  for (var off = 0; off < 200; off++) {
    var d = genBoard(li, off);
    var opt = bfs(d);
    if (opt !== null) {
      return { sz: d.sz, b: d.b, ho: d.ho, ca: d.ca, hl: d.hl, opt: opt, lim: opt + stepBuffer(li, opt), li: li, id: li + 1 };
    }
  }
  return { sz: 3, b: [0,0], ho: [2,2], ca: [[1,1]], hl: [], opt: 4, lim: 8, li: li, id: li + 1 };
}

var LVC = {};
function getLv(li) {
  if (!LVC[li]) LVC[li] = buildLevel(li);
  return LVC[li];
}

// ‚îÄ‚îÄ Tokens ‚îÄ‚îÄ
var TOKS = [
  { tp: 'm', dir: 'up', ico: '‚¨ÜÔ∏è' },
  { tp: 'm', dir: 'dn', ico: '‚¨áÔ∏è' },
  { tp: 'm', dir: 'lt', ico: '‚¨ÖÔ∏è' },
  { tp: 'm', dir: 'rt', ico: '‚û°Ô∏è' },
  { tp: 'j', dir: 'ne', ico: '‚ÜóÔ∏è' },
  { tp: 'j', dir: 'nw', ico: '‚ÜñÔ∏è' },
  { tp: 'j', dir: 'se', ico: '‚ÜòÔ∏è' },
  { tp: 'j', dir: 'sw', ico: '‚ÜôÔ∏è' }
];
var DVEC = { up: [-1,0], dn: [1,0], lt: [0,-1], rt: [0,1], ne: [-1,1], nw: [-1,-1], se: [1,1], sw: [1,-1] };

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
var TOTAL_LV = 10;
var NODE_STEP = 115, BOTTOM_PAD = 70, TOP_PAD = 130;
var G = { li: 0, hi: 0, stars: {}, bp: [0,0], cr: {}, crSize: 0, qu: [], run: false, lim: 0 };

function showHome() {
  hideM();
  document.getElementById('home').classList.add('active');
  document.getElementById('game').classList.remove('active');
  buildRoad();
  var prev = G.prevHi;
  G.prevHi = undefined;
  if (prev !== undefined && prev < G.hi) {
    setTimeout(function() { animateBunnyWalk(prev, G.hi); }, 150);
  } else {
    setTimeout(function() { scrollToNode(G.hi, false); }, 50);
  }
}

function showGame() {
  document.getElementById('game').classList.add('active');
  document.getElementById('home').classList.remove('active');
}

// ‚îÄ‚îÄ Road ‚îÄ‚îÄ
function nodeXY(i, W, totalH) {
  return { x: Math.round((i % 2 === 0 ? 0.72 : 0.28) * W), y: totalH - BOTTOM_PAD - i * NODE_STEP };
}

function buildRoad() {
  var canvas = document.getElementById('mapCanvas');
  canvas.innerHTML = '';
  document.getElementById('homeProg').textContent = Object.keys(G.stars).length + '/' + TOTAL_LV;
  var W = canvas.parentElement.clientWidth || 390;
  var totalH = TOTAL_LV * NODE_STEP + BOTTOM_PAD + TOP_PAD;
  canvas.style.height = totalH + 'px';

  var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  svg.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:' + totalH + 'px;pointer-events:none;';

  for (var i = 0; i < TOTAL_LV - 1; i++) {
    var a = nodeXY(i, W, totalH), b = nodeXY(i + 1, W, totalH);
    var midY = (a.y + b.y) / 2;
    var pd = 'M'+a.x+','+a.y+' C'+a.x+','+midY+' '+b.x+','+midY+' '+b.x+','+b.y;
    var isDoneSegment = i < G.hi - 1;

    var shadow = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    shadow.setAttribute('d', pd); shadow.setAttribute('fill', 'none');
    shadow.setAttribute('stroke', 'rgba(0,0,0,.10)'); shadow.setAttribute('stroke-width', '22');
    shadow.setAttribute('stroke-linecap', 'round'); svg.appendChild(shadow);

    var outer = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    outer.setAttribute('d', pd); outer.setAttribute('fill', 'none');
    outer.setAttribute('stroke', isDoneSegment ? '#2E8A5A' : '#B89060');
    outer.setAttribute('stroke-width', '20'); outer.setAttribute('stroke-linecap', 'round'); svg.appendChild(outer);

    var inner = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    inner.setAttribute('d', pd); inner.setAttribute('fill', 'none');
    inner.setAttribute('stroke', isDoneSegment ? '#5DC88A' : '#F0D8A8');
    inner.setAttribute('stroke-width', '13'); inner.setAttribute('stroke-linecap', 'round'); svg.appendChild(inner);

    var dash = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    dash.setAttribute('d', pd); dash.setAttribute('fill', 'none');
    dash.setAttribute('stroke', isDoneSegment ? 'rgba(255,255,255,.35)' : 'rgba(255,255,255,.5)');
    dash.setAttribute('stroke-width', '3'); dash.setAttribute('stroke-linecap', 'round');
    dash.setAttribute('stroke-dasharray', '1 14'); svg.appendChild(dash);
  }
  canvas.appendChild(svg);

  for (var i = 0; i < TOTAL_LV; i++) {
    var pos = nodeXY(i, W, totalH);
    var isDone = i < G.hi, isCur = i === G.hi, isLocked = i > G.hi;
    var n = document.createElement('div');
    n.id = 'node-' + i;
    n.className = 'lv-node ' + (isDone ? 'done' : isCur ? 'current' : 'locked');
    n.style.left = pos.x + 'px'; n.style.top = pos.y + 'px';
    n.innerHTML = isDone
      ? '<div class="lv-num">' + (i+1) + '</div><div class="lv-stars">‚≠ê‚≠ê‚≠ê</div>'
      : isCur
        ? '<div class="lv-ico">üê∞</div><div class="lv-num">' + (i+1) + '</div>'
        : '<div class="lv-ico">üîí</div><div class="lv-num">' + (i+1) + '</div>';
    if (!isLocked) (function(li) { n.addEventListener('click', function() { playLevel(li); }); })(i);
    canvas.appendChild(n);
  }
}

function scrollToNode(idx, smooth) {
  var scroll = document.getElementById('mapScroll');
  var canvas = document.getElementById('mapCanvas');
  var W = canvas.clientWidth || 390;
  var totalH = parseInt(canvas.style.height) || 0;
  var top = Math.max(0, nodeXY(idx, W, totalH).y - scroll.clientHeight * 0.62);
  if (smooth) scroll.scrollTo({ top: top, behavior: 'smooth' });
  else scroll.scrollTop = top;
}

function animateBunnyWalk(fromIdx, toIdx) {
  var canvas = document.getElementById('mapCanvas');
  var W = canvas.clientWidth || 390;
  var totalH = parseInt(canvas.style.height) || 0;
  var p0 = nodeXY(fromIdx, W, totalH), p1 = nodeXY(toIdx, W, totalH);
  var midY = (p0.y + p1.y) / 2;
  var toNode = document.getElementById('node-' + toIdx);
  var toIco = toNode && toNode.querySelector('.lv-ico');
  if (toIco) toIco.style.visibility = 'hidden';
  var walker = document.createElement('div');
  walker.className = 'bunny-walker'; walker.textContent = 'üê∞';
  walker.style.left = p0.x + 'px'; walker.style.top = p0.y + 'px';
  canvas.appendChild(walker);
  scrollToNode(fromIdx, false);
  var start = null, dur = 850;
  requestAnimationFrame(function step(ts) {
    if (!start) start = ts;
    var t = Math.min((ts - start) / dur, 1);
    var et = t < .5 ? 2*t*t : -1 + (4 - 2*t) * t;
    var mt = 1 - et;
    walker.style.left = (mt*mt*mt*p0.x + 3*mt*mt*et*p0.x + 3*mt*et*et*p1.x + et*et*et*p1.x) + 'px';
    walker.style.top  = (mt*mt*mt*p0.y + 3*mt*mt*et*midY + 3*mt*et*et*midY + et*et*et*p1.y) + 'px';
    if (t < 1) { requestAnimationFrame(step); }
    else { walker.remove(); if (toIco) toIco.style.visibility = ''; scrollToNode(toIdx, true); }
  });
}

function playLevel(li) { G.li = li; loadLevel(); showGame(); }

// ‚îÄ‚îÄ Load level ‚îÄ‚îÄ
function loadLevel() {
  var lv = getLv(G.li);
  G.bp = [lv.b[0], lv.b[1]];
  G.cr = {};
  for (var i = 0; i < lv.ca.length; i++) G.cr[lv.ca[i][0] + ',' + lv.ca[i][1]] = true;
  G.crSize = lv.ca.length;
  G.qu = []; G.run = false; G.lim = lv.lim;
  hideM();
  document.getElementById('hLv').textContent = 'Lv' + lv.id;
  document.getElementById('seqMax').textContent = lv.lim;
  updCr(); updSt(); buildPalette(); renderBoard(); renderQ();
  requestAnimationFrame(function() { requestAnimationFrame(sizeBoard); });
}

function sizeBoard() {
  var lv = getLv(G.li), n = lv.sz;
  var ba = document.getElementById('boardArea');
  var cs = Math.floor(Math.min(ba.clientWidth - 16, ba.clientHeight - 8) / n);
  var b = document.getElementById('board');
  b.style.gridTemplateColumns = 'repeat(' + n + ',' + cs + 'px)';
  b.style.gridTemplateRows = 'repeat(' + n + ',' + cs + 'px)';
  var ems = b.querySelectorAll('.cell-em');
  for (var i = 0; i < ems.length; i++) ems[i].style.fontSize = Math.floor(cs * 0.66) + 'px';
}

function updCr() { document.getElementById('hCr').textContent = G.crSize; }
function updSt() {
  var rem = G.lim - G.qu.length;
  document.getElementById('hSt').textContent = rem;
  document.getElementById('seqUsed').textContent = G.qu.length;
  document.getElementById('hStChip').classList.toggle('chip-warn', rem <= 3 && rem > 0);
  var toks = document.querySelectorAll('.tok');
  for (var i = 0; i < toks.length; i++) toks[i].classList.toggle('disabled', G.qu.length >= G.lim || G.run);
}

// ‚îÄ‚îÄ Board ‚îÄ‚îÄ
function renderBoard(hopPos) {
  var lv = getLv(G.li), sz = lv.sz, hl = lv.hl, ho = lv.ho;
  var board = document.getElementById('board');
  board.innerHTML = ''; board.classList.remove('shake');
  var allOut = G.crSize === 0;
  for (var r = 0; r < sz; r++) {
    for (var c = 0; c < sz; c++) {
      var d = document.createElement('div');
      d.className = 'cell'; d.id = 'c' + r + '_' + c;
      var iB = r === G.bp[0] && c === G.bp[1];
      var iCa = G.cr[r + ',' + c];
      var iHl = false;
      for (var hi = 0; hi < hl.length; hi++) { if (hl[hi][0] === r && hl[hi][1] === c) { iHl = true; break; } }
      var iHo = ho[0] === r && ho[1] === c;
      var em = '';
      if (iHl) { d.classList.add('c-hole'); em = '‚ö´'; }
      else if (iB) { d.classList.add('c-bunny'); em = 'üê∞'; }
      else if (iCa) { d.classList.add('c-carrot'); em = 'ü•ï'; }
      else if (iHo) { d.classList.add(allOut ? 'c-house-glow' : 'c-house'); em = 'üè†'; }
      if (em) {
        var s = document.createElement('span');
        s.className = 'cell-em'; s.textContent = em;
        if (iB && hopPos && hopPos[0] === r && hopPos[1] === c) s.classList.add('hop');
        d.appendChild(s);
      }
      board.appendChild(d);
    }
  }
  sizeBoard();
}

// ‚îÄ‚îÄ Palette + drag ‚îÄ‚îÄ
var dragTokIdx = null, touchDragActive = false;

function buildPalette() {
  var pal = document.getElementById('palette');
  pal.innerHTML = '';
  for (var i = 0; i < TOKS.length; i++) {
    var t = TOKS[i];
    var d = document.createElement('div');
    d.className = 'tok ' + (t.tp === 'j' ? 'tj' : 'tm');
    d.innerHTML = '<span class="ti">' + t.ico + '</span>';
    (function(idx, tok) {
      d.addEventListener('click', function() { addQ(idx); });
      d.addEventListener('mousedown', function(e) { startMouseDrag(e, idx, tok); });
      d.addEventListener('touchstart', function(e) { startTouchDrag(e, idx, tok); }, { passive: true });
    })(i, t);
    pal.appendChild(d);
  }
  var qw = document.getElementById('qWrap');
  qw.addEventListener('dragover', function(e) { e.preventDefault(); qw.classList.add('drag-over'); });
  qw.addEventListener('dragleave', function() { qw.classList.remove('drag-over'); });
  qw.addEventListener('drop', function(e) { e.preventDefault(); qw.classList.remove('drag-over'); if (dragTokIdx !== null) { addQ(dragTokIdx); dragTokIdx = null; } });
}

var ghost = document.getElementById('dragGhost');
function showGhost(t, x, y) {
  ghost.textContent = t.ico;
  ghost.style.background = t.tp === 'j' ? '#FFF4EF' : '#EDF6FF';
  ghost.style.display = 'flex';
  ghost.style.left = x + 'px'; ghost.style.top = y + 'px';
}
function hideGhost() { ghost.style.display = 'none'; }
function isOverQueue(x, y) {
  var r = document.getElementById('qWrap').getBoundingClientRect();
  return x >= r.left && x <= r.right && y >= r.top && y <= r.bottom;
}

function startMouseDrag(e, idx, tok) {
  if (G.qu.length >= G.lim || G.run) return;
  dragTokIdx = idx; showGhost(tok, e.clientX, e.clientY);
  function mv(ev) { ghost.style.left = ev.clientX + 'px'; ghost.style.top = ev.clientY + 'px'; document.getElementById('qWrap').classList.toggle('drag-over', isOverQueue(ev.clientX, ev.clientY)); }
  function up(ev) {
    hideGhost(); document.getElementById('qWrap').classList.remove('drag-over');
    document.removeEventListener('mousemove', mv); document.removeEventListener('mouseup', up);
    if (isOverQueue(ev.clientX, ev.clientY)) addQ(dragTokIdx);
    dragTokIdx = null;
  }
  document.addEventListener('mousemove', mv); document.addEventListener('mouseup', up);
}

function startTouchDrag(e, idx, tok) {
  if (G.qu.length >= G.lim || G.run) return;
  dragTokIdx = idx; touchDragActive = true;
  var tc = e.touches[0]; showGhost(tok, tc.clientX, tc.clientY);
  function mv(ev) { var tc = ev.touches[0]; ghost.style.left = tc.clientX + 'px'; ghost.style.top = tc.clientY + 'px'; document.getElementById('qWrap').classList.toggle('drag-over', isOverQueue(tc.clientX, tc.clientY)); ev.preventDefault(); }
  function up(ev) {
    hideGhost(); touchDragActive = false; document.getElementById('qWrap').classList.remove('drag-over');
    document.removeEventListener('touchmove', mv); document.removeEventListener('touchend', up);
    var tc = ev.changedTouches[0]; if (isOverQueue(tc.clientX, tc.clientY)) addQ(dragTokIdx);
    dragTokIdx = null;
  }
  document.addEventListener('touchmove', mv, { passive: false }); document.addEventListener('touchend', up);
}

function addQ(i) { if (G.qu.length >= G.lim || G.run) return; G.qu.push(TOKS[i]); renderQ(); }

function renderQ() {
  var wrap = document.getElementById('qWrap');
  var old = wrap.querySelectorAll('.qt');
  for (var i = 0; i < old.length; i++) old[i].remove();
  document.getElementById('qHint').style.display = G.qu.length ? 'none' : 'block';
  for (var i = 0; i < G.qu.length; i++) {
    var t = G.qu[i];
    var d = document.createElement('div');
    d.className = 'qt' + (t.tp === 'j' ? ' qj' : '');
    d.id = 'qt' + i; d.textContent = t.ico;
    (function(qi) { d.addEventListener('click', function() { if (!G.run) { G.qu.splice(qi, 1); renderQ(); } }); })(i);
    wrap.appendChild(d);
  }
  updSt();
  document.getElementById('btnRun').disabled = G.qu.length === 0 || G.run;
}

function clearQ() { if (G.run) return; G.qu = []; renderQ(); }

// ‚îÄ‚îÄ Run ‚îÄ‚îÄ
function sleep(ms) { return new Promise(function(r) { setTimeout(r, ms); }); }

async function runSteps() {
  if (G.run || G.qu.length === 0) return;
  G.run = true;
  var btn = document.getElementById('btnRun'); btn.disabled = true; btn.textContent = 'üê∞ Running‚Ä¶';
  document.getElementById('palette').style.pointerEvents = 'none';
  var lv = getLv(G.li), steps = G.qu.slice();
  var hitHole = false, hitWall = false, didWin = false;

  for (var i = 0; i < steps.length; i++) {
    var qels = document.querySelectorAll('.qt.active-step');
    for (var x = 0; x < qels.length; x++) qels[x].classList.remove('active-step');
    var qel = document.getElementById('qt' + i);
    if (qel) { qel.classList.add('active-step'); qel.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' }); }

    var result = doStep(steps[i]);
    if (result === 'wall') {
      document.getElementById('board').classList.add('shake'); await sleep(420); hitWall = true;
      if (qel) qel.classList.remove('active-step');
      break;
    }
    renderBoard(G.bp); await sleep(300);
    if (qel) { qel.classList.remove('active-step'); qel.classList.add('done-step'); }
    var r = G.bp[0], c = G.bp[1];
    var inHole = false;
    for (var h = 0; h < lv.hl.length; h++) { if (lv.hl[h][0] === r && lv.hl[h][1] === c) { inHole = true; break; } }
    if (inHole) { hitHole = true; document.getElementById('board').classList.add('shake'); await sleep(450); break; }
    if (G.crSize === 0 && r === lv.ho[0] && c === lv.ho[1]) { didWin = true; break; }
  }

  await sleep(250);
  G.run = false; btn.textContent = '‚ñ∂ Run!';
  document.getElementById('palette').style.pointerEvents = '';
  G.qu = []; renderQ();

  if (didWin) doWin();
  else if (hitWall) showFail('üß±', 'Hit a wall!', "Bunny can't leave the grid!");
  else if (hitHole) showFail('üò±', 'Fell in a hole!', 'Use diagonal jumps to dodge holes!');
  else {
    var r = G.bp[0], c = G.bp[1];
    var atHome = r === lv.ho[0] && c === lv.ho[1];
    if (atHome && G.crSize > 0) showFail('ü•ï', 'Missing carrots!', 'Reached home but missed ' + G.crSize + ' carrot' + (G.crSize > 1 ? 's' : '') + '!');
    else if (G.crSize > 0) showFail('ü§î', 'Not done yet!', G.crSize + ' carrot' + (G.crSize > 1 ? 's' : '') + ' still on the board!');
    else showFail('üè†', 'So close!', "All carrots collected but bunny didn't reach home!");
  }
}

function doStep(step) {
  var lv = getLv(G.li);
  var dv = DVEC[step.dir];
  var nr = G.bp[0] + dv[0], nc = G.bp[1] + dv[1];
  if (nr < 0 || nr >= lv.sz || nc < 0 || nc >= lv.sz) return 'wall';
  var old = document.getElementById('c' + G.bp[0] + '_' + G.bp[1]);
  if (old) { old.className = 'cell trail'; old.innerHTML = ''; }
  G.bp = [nr, nc];
  var key = nr + ',' + nc;
  if (G.cr[key]) { delete G.cr[key]; G.crSize--; updCr(); }
  return 'ok';
}

function saveProgress() {
  try { localStorage.setItem('bh_save', JSON.stringify({ hi: G.hi, stars: G.stars })); } catch(e) {}
}

function doWin() {
  var oldTotal = TOTAL_LV;
  G.prevHi = G.hi;
  if (G.li >= G.hi) G.hi = G.li + 1;
  G.stars[G.li] = 3;
  TOTAL_LV = Math.ceil((G.hi + 1) / 10) * 10;
  saveProgress();
  document.getElementById('mSub').textContent = TOTAL_LV > oldTotal ? '10 new levels unlocked! üó∫Ô∏è' : 'Bunny is home! üè†ü•ï';
  launchConfetti(); document.getElementById('winMod').style.display = 'flex';
}
function showFail(ico, t, s) {
  document.getElementById('fIco').textContent = ico;
  document.getElementById('fTitle').textContent = t;
  document.getElementById('fSub').textContent = s;
  document.getElementById('failMod').style.display = 'flex';
}
function hideM() { document.getElementById('winMod').style.display = 'none'; document.getElementById('failMod').style.display = 'none'; }
function nextLevel() { hideM(); if (G.li < TOTAL_LV - 1) { G.li++; loadLevel(); } else showHome(); }
function retryLevel() { hideM(); loadLevel(); }

function launchConfetti() {
  var w = document.getElementById('cfWrap'); w.innerHTML = '';
  var cols = ['#FF8C70','#4CAF7C','#5AABDF','#FFD54F','#E4C8FF','#C8F0D8'];
  for (var i = 0; i < 55; i++) {
    var p = document.createElement('div'); p.className = 'cfp';
    p.style.cssText = 'left:' + (Math.random()*100) + '%;width:' + (6+Math.random()*7) + 'px;height:' + (5+Math.random()*7) + 'px;background:' + cols[i%cols.length] + ';border-radius:' + (Math.random()>.5?'50%':'2px') + ';animation-duration:' + (1.4+Math.random()*1.4) + 's;animation-delay:' + (Math.random()*.6) + 's;';
    w.appendChild(p);
  }
}

window.addEventListener('resize', function() { if (document.getElementById('game').classList.contains('active')) sizeBoard(); });
window.addEventListener('beforeunload', saveProgress);

window.addEventListener('DOMContentLoaded', function() {
  G.hi = 0; G.stars = {};
  try {
    var saved = JSON.parse(localStorage.getItem('bh_save') || 'null');
    if (saved) { G.hi = saved.hi || 0; G.stars = saved.stars || {}; TOTAL_LV = Math.ceil((G.hi + 1) / 10) * 10; }
  } catch(e) {}
  setTimeout(function() { for (var i = 0; i < 5; i++) getLv(i); }, 200);
  showHome();
  document.addEventListener('touchmove', function(e) {
    if (e.target.closest('.map-scroll,.queue-wrap,.palette-row')) return;
    if (!touchDragActive) e.preventDefault();
  }, { passive: false });
});
</script>
</body>
</html>
